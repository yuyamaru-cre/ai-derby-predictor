import { useState, useEffect } from 'react';
import { Trophy, Copy, Check, Sparkles, TrendingUp, Info, Upload, FileText, X, ChevronDown, ChevronUp, Search, BookOpen, Brain, Target, AlertCircle } from 'lucide-react';

export default function HorseRacingApp() {
  const [mode, setMode] = useState('predict'); // 'predict' or 'learn'
  const [pdfFile, setPdfFile] = useState(null);
  const [raceInfo, setRaceInfo] = useState('');
  const [predictionStyle, setPredictionStyle] = useState('balanced');
  const [pastData, setPastData] = useState('');
  const [prediction, setPrediction] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [isSearching, setIsSearching] = useState(false);
  const [searchProgress, setSearchProgress] = useState('');
  const [analysisProgress, setAnalysisProgress] = useState('');
  const [webData, setWebData] = useState('');
  const [copied, setCopied] = useState(false);
  const [showPastData, setShowPastData] = useState(false);
  const [showRawData, setShowRawData] = useState(false);
  const [extractedData, setExtractedData] = useState('');
  
  // å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ç”¨
  const [learningPrediction, setLearningPrediction] = useState('');
  const [actualResult, setActualResult] = useState('');
  const [comparison, setComparison] = useState('');
  const [learningData, setLearningData] = useState(null);
  const [learningCount, setLearningCount] = useState(0);

  const styles = [
    { value: 'balanced', label: 'ãƒãƒ©ãƒ³ã‚¹å‹', description: 'ãƒ‡ãƒ¼ã‚¿ã¨ç›´æ„Ÿã‚’çµ„ã¿åˆã‚ã›' },
    { value: 'data', label: 'ãƒ‡ãƒ¼ã‚¿é‡è¦–', description: 'çµ±è¨ˆã¨æ•°å­—ã‚’ä¸­å¿ƒã«åˆ†æ' },
    { value: 'intuitive', label: 'ç›´æ„Ÿé‡è¦–', description: 'çµŒé¨“ã¨å‹˜ã‚’æ´»ã‹ã—ãŸäºˆæƒ³' },
    { value: 'conservative', label: 'å …å®Ÿæ´¾', description: 'æ‰‹å …ã„æœ¬å‘½ä¸­å¿ƒã®äºˆæƒ³' },
    { value: 'aggressive', label: 'ç©´ç‹™ã„', description: 'é«˜é…å½“ã‚’ç‹™ã£ãŸäºˆæƒ³' },
    { value: 'professional', label: 'ãƒ—ãƒ­ç›®ç·š', description: 'å°‚é–€å®¶ã®ã‚ˆã†ãªè©³ç´°åˆ†æ' }
  ];

  // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ“ä½œã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰
  const storageGet = async (key) => {
    try {
      // ã¾ãšwindow.storageã‚’è©¦ã™
      if (window.storage && typeof window.storage.get === 'function') {
        const result = await window.storage.get(key);
        return result ? result.value : null;
      }
    } catch (error) {
      console.log('window.storageä½¿ç”¨ä¸å¯ã€localStorageã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯');
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: localStorage
    try {
      return localStorage.getItem(key);
    } catch (error) {
      console.error('localStorageèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      return null;
    }
  };

  const storageSet = async (key, value) => {
    try {
      // ã¾ãšwindow.storageã‚’è©¦ã™
      if (window.storage && typeof window.storage.set === 'function') {
        await window.storage.set(key, value);
        return true;
      }
    } catch (error) {
      console.log('window.storageä½¿ç”¨ä¸å¯ã€localStorageã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯');
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: localStorage
    try {
      localStorage.setItem(key, value);
      return true;
    } catch (error) {
      console.error('localStorageä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      return false;
    }
  };

  const storageDelete = async (key) => {
    try {
      if (window.storage && typeof window.storage.delete === 'function') {
        await window.storage.delete(key);
        return true;
      }
    } catch (error) {
      console.log('window.storageä½¿ç”¨ä¸å¯ã€localStorageã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯');
    }
    
    try {
      localStorage.removeItem(key);
      return true;
    } catch (error) {
      console.error('localStorageå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
      return false;
    }
  };

  const storageList = async (prefix) => {
    try {
      if (window.storage && typeof window.storage.list === 'function') {
        return await window.storage.list(prefix);
      }
    } catch (error) {
      console.log('window.storageä½¿ç”¨ä¸å¯ã€localStorageã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯');
    }
    
    // localStorageç‰ˆã®listå®Ÿè£…
    try {
      const keys = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith(prefix)) {
          keys.push(key);
        }
      }
      return { keys };
    } catch (error) {
      console.error('localStorageãƒªã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
      return { keys: [] };
    }
  };

  // å­¦ç¿’ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  useEffect(() => {
    loadLearningData();
  }, []);

  const loadLearningData = async () => {
    try {
      const value = await storageGet('learning:summary');
      if (value) {
        const data = JSON.parse(value);
        setLearningData(data);
        setLearningCount(data.totalLearnings || 0);
        console.log('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ:', data.totalLearnings, 'ä»¶');
      } else {
        console.log('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãªã—ã€æ–°è¦é–‹å§‹');
      }
    } catch (error) {
      console.error('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      alert('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }
  };

  const handleFileUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    // PDFã¾ãŸã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
    const isPDF = file.type === 'application/pdf';
    const isImage = file.type.startsWith('image/');
    
    if (!isPDF && !isImage) {
      alert('PDFã¾ãŸã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆJPGã€PNGç­‰ï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    setPdfFile(file);
    setIsAnalyzing(true);

    try {
      const base64Data = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = () => reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—'));
        reader.readAsDataURL(file);
      });

      // PDFã‹ç”»åƒã‹ã§é€ä¿¡å½¢å¼ã‚’å¤‰æ›´
      const contentPayload = isPDF ? {
        type: "document",
        source: {
          type: "base64",
          media_type: "application/pdf",
          data: base64Data
        }
      } : {
        type: "image",
        source: {
          type: "base64",
          media_type: file.type,
          data: base64Data
        }
      };

      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 2000,
          messages: [
            {
              role: "user",
              content: [
                contentPayload,
                {
                  type: "text",
                  text: `ã“ã®JRAå‡ºé¦¬è¡¨${isPDF ? 'PDF' : 'ç”»åƒ'}ã‹ã‚‰ä»¥ä¸‹ã®æƒ…å ±ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ï¼š

ã€æŠ½å‡ºé …ç›®ã€‘
1. ãƒ¬ãƒ¼ã‚¹å
2. é–‹å‚¬å ´ï¼ˆç«¶é¦¬å ´åï¼‰
3. è·é›¢ï¼ˆä¾‹ï¼šèŠ1600mï¼‰
4. é¦¬å ´çŠ¶æ…‹
5. é–‹å‚¬æ—¥æ™‚
6. å‡ºèµ°é¦¬ãƒªã‚¹ãƒˆï¼ˆé¦¬ç•ªã€é¦¬åã€é¨æ‰‹ã€æ–¤é‡ã€ã‚ªãƒƒã‚ºï¼‰

${mode === 'learn' ? '\nâ€»å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ¬ãƒ¼ã‚¹çµæœã¯æŠ½å‡ºã—ãªã„ã§ãã ã•ã„' : ''}

ã€å‡ºåŠ›å½¢å¼ã€‘
ãƒ¬ãƒ¼ã‚¹åï¼š
é–‹å‚¬å ´ï¼š
è·é›¢ï¼š
é¦¬å ´ï¼š
é–‹å‚¬æ—¥ï¼š

ã€å‡ºèµ°é¦¬ã€‘
1ç•ª é¦¬å / é¨æ‰‹å / æ–¤é‡ / ã‚ªãƒƒã‚º
2ç•ª ...`
                }
              ]
            }
          ],
        })
      });

      const data = await response.json();
      const text = data.content.map(item => item.text || "").join("\n");
      setExtractedData(text.trim());
      setRaceInfo(text.trim());
    } catch (error) {
      console.error('ãƒ•ã‚¡ã‚¤ãƒ«è§£æã‚¨ãƒ©ãƒ¼:', error);
      alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    } finally {
      setIsAnalyzing(false);
    }
  };

  const removePdf = () => {
    setPdfFile(null);
    setExtractedData('');
    setRaceInfo('');
    setWebData('');
    setLearningPrediction('');
    setActualResult('');
    setComparison('');
  };

  const searchActualResult = async () => {
    if (!extractedData) {
      alert('ãƒ¬ãƒ¼ã‚¹æƒ…å ±ãŒå¿…è¦ã§ã™');
      return;
    }

    setIsSearching(true);
    setSearchProgress('ãƒ¬ãƒ¼ã‚¹çµæœã‚’æ¤œç´¢ä¸­...');

    try {
      const raceNameMatch = extractedData.match(/ãƒ¬ãƒ¼ã‚¹å[ï¼š:]\s*(.+)/);
      const venueMatch = extractedData.match(/é–‹å‚¬å ´[ï¼š:]\s*(.+)/);
      const dateMatch = extractedData.match(/é–‹å‚¬æ—¥[ï¼š:]\s*(.+)/);

      if (!raceNameMatch) {
        alert('ãƒ¬ãƒ¼ã‚¹åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        setIsSearching(false);
        return;
      }

      // æ—¥ä»˜ã‚’å¿…ãšå«ã‚ã‚‹
      const searchQuery = `${dateMatch?.[1] || ''} ${venueMatch?.[1] || ''} ${raceNameMatch[1]} çµæœ`;
      
      console.log('æ¤œç´¢ã‚¯ã‚¨ãƒª:', searchQuery); // ãƒ‡ãƒãƒƒã‚°ç”¨

      const resultResponse = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 600,
          tools: [{ type: "web_search_20250305", name: "web_search" }],
          messages: [
            { 
              role: "user", 
              content: `ã“ã®ãƒ¬ãƒ¼ã‚¹ã®çµæœã‚’èª¿ã¹ã¦ãã ã•ã„ï¼š
${searchQuery}

â€»ã“ã‚Œã¯éå»ã«é–‹å‚¬ã•ã‚ŒãŸãƒ¬ãƒ¼ã‚¹ã§ã™ã€‚

1-3ç€ã®é¦¬ç•ªã¨é¦¬åã‚’ä»¥ä¸‹ã®å½¢å¼ã§ï¼š
1ç€: é¦¬ç•ª é¦¬å
2ç€: é¦¬ç•ª é¦¬å
3ç€: é¦¬ç•ª é¦¬å` 
            }
          ],
        })
      });

      const resultData = await resultResponse.json();
      const resultText = resultData.content.map(item => item.text || "").join("\n");
      
      if (resultText && resultText.length > 20) {
        setActualResult(resultText);
        setSearchProgress('âœ“ çµæœå–å¾—å®Œäº†');
      } else {
        setSearchProgress('çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      }
    } catch (error) {
      console.error('çµæœæ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
      setSearchProgress('æ¤œç´¢ã‚¨ãƒ©ãƒ¼ã€‚æ‰‹å‹•å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
    } finally {
      setIsSearching(false);
    }
  };

  const searchWebData = async () => {
    if (!extractedData) {
      alert('ã¾ãšPDFã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„');
      return;
    }

    setIsSearching(true);
    setWebData('');
    let allSearchData = '';

    try {
      const venueMatch = extractedData.match(/é–‹å‚¬å ´[ï¼š:]\s*(.+)/);
      const dateMatch = extractedData.match(/é–‹å‚¬æ—¥[ï¼š:]\s*(.+)/);
      
      if (venueMatch && dateMatch) {
        setSearchProgress('å¤©æ°—äºˆå ±ã‚’æ¤œç´¢ä¸­...');
        const weatherResponse = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 500,
            tools: [{ type: "web_search_20250305", name: "web_search" }],
            messages: [
              { 
                role: "user", 
                content: `${venueMatch[1]} ${dateMatch[1]} å¤©æ°—

å¤©æ°—ã€æ°—æ¸©ã€é¦¬å ´ã¸ã®å½±éŸ¿ã‚’150æ–‡å­—ä»¥å†…ã§ã€‚` 
              }
            ],
          })
        });

        const weatherData = await weatherResponse.json();
        const weatherText = weatherData.content.map(item => item.text || "").join("\n");
        allSearchData += `ã€å¤©æ°—äºˆå ±ã€‘\n${weatherText}\n\n`;
      }

      const horseMatches = [...extractedData.matchAll(/(\d+)ç•ª\s+([^\s/]+)/g)];
      const horsesToSearch = horseMatches.slice(0, 5);
      
      for (let i = 0; i < horsesToSearch.length; i++) {
        const [, number, horseName] = horsesToSearch[i];
        setSearchProgress(`${horseName}ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ä¸­... (${i + 1}/${horsesToSearch.length})`);

        const horseResponse = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 600,
            tools: [{ type: "web_search_20250305", name: "web_search" }],
            messages: [
              { 
                role: "user", 
                content: `ç«¶èµ°é¦¬ ${horseName} netkeiba

è„šè³ªã€å¾—æ„ã‚³ãƒ¼ã‚¹ã€æœ€è¿‘3èµ°ã‚’200æ–‡å­—ä»¥å†…ã§ã€‚` 
              }
            ],
          })
        });

        const horseData = await horseResponse.json();
        const horseText = horseData.content.map(item => item.text || "").join("\n");
        allSearchData += `ã€${number}ç•ª ${horseName}ã€‘\n${horseText}\n\n`;

        await new Promise(resolve => setTimeout(resolve, 1000));
      }

      if (horsesToSearch.length < horseMatches.length) {
        allSearchData += `â€»æ®‹ã‚Š${horseMatches.length - horsesToSearch.length}é ­ã«ã¤ã„ã¦ã¯åŸºæœ¬æƒ…å ±ã®ã¿ã§äºˆæƒ³ã—ã¾ã™\n`;
      }

      setWebData(allSearchData);
      setSearchProgress('âœ“ æ¤œç´¢å®Œäº†');
    } catch (error) {
      console.error('Webæ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
      alert('ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    } finally {
      setIsSearching(false);
    }
  };

  const generatePrediction = async (isLearningMode = false) => {
    if (!raceInfo.trim()) return;

    setIsLoading(true);
    if (isLearningMode) {
      setLearningPrediction('');
    } else {
      setPrediction('');
    }
    setAnalysisProgress('');
    let fullPrediction = '';

    try {
      const styleDesc = {
        balanced: 'ãƒ‡ãƒ¼ã‚¿ã¨ç›´æ„Ÿã‚’ãƒãƒ©ãƒ³ã‚¹ã‚ˆãçµ„ã¿åˆã‚ã›ãŸ',
        data: 'ãƒ‡ãƒ¼ã‚¿ã¨çµ±è¨ˆã‚’é‡è¦–ã—ãŸ',
        intuitive: 'çµŒé¨“ã¨ç›´æ„Ÿã‚’é‡è¦–ã—ãŸ',
        conservative: 'æ‰‹å …ãå …å®Ÿãª',
        aggressive: 'é«˜é…å½“ã®ç©´ã‚’ç‹™ã£ãŸ',
        professional: 'ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªè¦–ç‚¹ã§ã®'
      };

      // å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’æ´»ç”¨
      let learningContext = '';
      if (!isLearningMode && learningData) {
        learningContext = `\nã€éå»ã®å­¦ç¿’ã‹ã‚‰å¾—ãŸçŸ¥è¦‹ã€‘\n${JSON.stringify(learningData.insights || []).slice(0, 500)}\nâ€»ã“ã‚Œã‚‰ã®çŸ¥è¦‹ã‚’æ´»ç”¨ã—ã¦äºˆæƒ³ç²¾åº¦ã‚’å‘ä¸Šã•ã›ã¦ãã ã•ã„ã€‚\n\n`;
      }

      // ãƒ•ã‚§ãƒ¼ã‚º1: ãƒ¬ãƒ¼ã‚¹å…¨ä½“åˆ†æ
      setAnalysisProgress('ãƒ•ã‚§ãƒ¼ã‚º1: ãƒ¬ãƒ¼ã‚¹å…¨ä½“ã‚’åˆ†æä¸­...');
      
      const phase1Response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1000,
          messages: [
            { 
              role: "user", 
              content: `ã‚ãªãŸã¯ç«¶é¦¬äºˆæƒ³ã®ãƒ—ãƒ­ã§ã™ã€‚ä»¥ä¸‹ã®ãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

ã€ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ±ã€‘
${raceInfo}

${webData ? `ã€Webæ¤œç´¢ãƒ‡ãƒ¼ã‚¿ã€‘\n${webData}\n` : ''}

${pastData ? `ã€è¿½åŠ æƒ…å ±ã€‘\n${pastData}\n` : ''}

${learningContext}

ã€ã‚¿ã‚¹ã‚¯ã€‘
ã“ã®ãƒ¬ãƒ¼ã‚¹å…¨ä½“ã‚’åˆ†æã—ã€ä»¥ä¸‹ã®ç‚¹ã«ã¤ã„ã¦è¿°ã¹ã¦ãã ã•ã„ï¼š

1. ã‚³ãƒ¼ã‚¹ç‰¹æ€§ï¼ˆèŠ/ãƒ€ãƒ¼ãƒˆã€è·é›¢ã€å›ã‚Šæ–¹ï¼‰
2. é¦¬å ´çŠ¶æ…‹ã¨ãã®å½±éŸ¿
3. å¤©æ°—ã®å½±éŸ¿ï¼ˆé›¨ã®å ´åˆã¯ç‰¹ã«ï¼‰
4. äºˆæƒ³ã•ã‚Œã‚‹ãƒ¬ãƒ¼ã‚¹å±•é–‹ï¼ˆãƒã‚¤ãƒšãƒ¼ã‚¹/ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹ï¼‰
5. æœ‰åˆ©ãªè„šè³ª

ã€å‡ºåŠ›å½¢å¼ã€‘
ç°¡æ½”ã«ã€300æ–‡å­—ç¨‹åº¦ã§ã€‚` 
            }
          ],
        })
      });

      const phase1Data = await phase1Response.json();
      const phase1Text = phase1Data.content.map(item => item.text || "").join("\n");
      fullPrediction += `ã€ãƒ¬ãƒ¼ã‚¹åˆ†æã€‘\n${phase1Text}\n\n`;

      // ãƒ•ã‚§ãƒ¼ã‚º2: å„é¦¬ã®è©•ä¾¡
      setAnalysisProgress('ãƒ•ã‚§ãƒ¼ã‚º2: å„é¦¬ã‚’è©•ä¾¡ä¸­...');
      
      const phase2Response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1200,
          messages: [
            { 
              role: "user", 
              content: `ã€å‰ãƒ•ã‚§ãƒ¼ã‚ºã®åˆ†æçµæœã€‘
${phase1Text}

ã€ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ±ã€‘
${raceInfo}

${webData ? `ã€å„é¦¬ã®è©³ç´°ãƒ‡ãƒ¼ã‚¿ã€‘\n${webData}\n` : ''}

${learningContext}

ã€ã‚¿ã‚¹ã‚¯ã€‘
ä¸Šè¨˜ã®ãƒ¬ãƒ¼ã‚¹åˆ†æã‚’è¸ã¾ãˆã¦ã€${styleDesc[predictionStyle]}äºˆæƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã§å„é¦¬ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚

ã€è©•ä¾¡ãƒã‚¤ãƒ³ãƒˆã€‘
- ãƒ¬ãƒ¼ã‚¹å±•é–‹ã¨ã®ç›¸æ€§
- è„šè³ªã®é©æ€§
- éå»æˆç¸¾ã¨ã‚³ãƒ¼ã‚¹é©æ€§
- é¨æ‰‹ã¨ã®ç›¸æ€§
- èª¿å­ãƒ»å‹¢ã„

ã€å‡ºåŠ›å½¢å¼ã€‘
å„é¦¬ã«ã¤ã„ã¦ã€è©•ä¾¡ã‚’ç°¡æ½”ã«ï¼ˆ1é ­ã‚ãŸã‚Š50-100æ–‡å­—ï¼‰ã€‚` 
            }
          ],
        })
      });

      const phase2Data = await phase2Response.json();
      const phase2Text = phase2Data.content.map(item => item.text || "").join("\n");
      fullPrediction += `ã€å„é¦¬è©•ä¾¡ã€‘\n${phase2Text}\n\n`;

      // ãƒ•ã‚§ãƒ¼ã‚º3: æœ¬å‘½ãƒ»å¯¾æŠ—ãƒ»å˜ç©´ãƒ»é€£ä¸‹ã®æ±ºå®š
      setAnalysisProgress('ãƒ•ã‚§ãƒ¼ã‚º3: äºˆæƒ³å°ã‚’æ±ºå®šä¸­...');
      
      const phase3Response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1200,
          messages: [
            { 
              role: "user", 
              content: `ã€ãƒ¬ãƒ¼ã‚¹åˆ†æã€‘
${phase1Text}

ã€å„é¦¬è©•ä¾¡ã€‘
${phase2Text}

${learningContext}

ã€ã‚¿ã‚¹ã‚¯ã€‘
ä¸Šè¨˜ã®åˆ†æã‚’ç·åˆã—ã¦ã€${styleDesc[predictionStyle]}äºˆæƒ³ã§ä»¥ä¸‹ã‚’æ±ºå®šã—ã¦ãã ã•ã„ï¼š

â—æœ¬å‘½ï¼ˆ1é ­ï¼‰ï¼šæœ€ã‚‚å‹ã¤å¯èƒ½æ€§ãŒé«˜ã„é¦¬
â—‹å¯¾æŠ—ï¼ˆ1é ­ï¼‰ï¼šæœ¬å‘½ã«æ¬¡ãæœ‰åŠ›é¦¬
â–²å˜ç©´ï¼ˆ1é ­ï¼‰ï¼š3ç€ä»¥å†…ã®å¯èƒ½æ€§ãŒã‚ã‚‹ç©´é¦¬
â–³é€£ä¸‹ï¼ˆ1-2é ­ï¼‰ï¼šé¦¬åˆ¸åœå†…ã«çµ¡ã‚€å¯èƒ½æ€§ã®ã‚ã‚‹é¦¬

ã€å‡ºåŠ›å½¢å¼ã€‘
ã€æœ¬å‘½ã€‘â—
é¦¬ç•ªãƒ»é¦¬å
ç†ç”±ï¼šï¼ˆ100æ–‡å­—ç¨‹åº¦ï¼‰

ã€å¯¾æŠ—ã€‘â—‹
é¦¬ç•ªãƒ»é¦¬å
ç†ç”±ï¼šï¼ˆ100æ–‡å­—ç¨‹åº¦ï¼‰

ã€å˜ç©´ã€‘â–²
é¦¬ç•ªãƒ»é¦¬å
ç†ç”±ï¼šï¼ˆ100æ–‡å­—ç¨‹åº¦ï¼‰

ã€é€£ä¸‹ã€‘â–³
é¦¬ç•ªãƒ»é¦¬å
ç†ç”±ï¼šï¼ˆ50æ–‡å­—ç¨‹åº¦ï¼‰` 
            }
          ],
        })
      });

      const phase3Data = await phase3Response.json();
      const phase3Text = phase3Data.content.map(item => item.text || "").join("\n");
      fullPrediction += phase3Text + '\n\n';

      // ãƒ•ã‚§ãƒ¼ã‚º4: è²·ã„ç›®ææ¡ˆã¨ç·è©•
      setAnalysisProgress('ãƒ•ã‚§ãƒ¼ã‚º4: è²·ã„ç›®ææ¡ˆã‚’ä½œæˆä¸­...');
      
      const phase4Response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1000,
          messages: [
            { 
              role: "user", 
              content: `ã€ã“ã‚Œã¾ã§ã®åˆ†æã€‘
${fullPrediction}

ã€ã‚¿ã‚¹ã‚¯ã€‘
ä¸Šè¨˜ã®äºˆæƒ³ã‚’å…ƒã«ã€ä»¥ä¸‹ã‚’ææ¡ˆã—ã¦ãã ã•ã„ï¼š

1. è²·ã„ç›®ææ¡ˆï¼ˆä¸‰é€£å˜ã€ä¸‰é€£è¤‡ã€é¦¬å˜ãªã©å…·ä½“çš„ã«ï¼‰
2. ãƒ¬ãƒ¼ã‚¹å±•é–‹äºˆæƒ³ï¼ˆåºç›¤ã€œä¸­ç›¤ã€œçµ‚ç›¤ï¼‰
3. ç·è©•ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹

ã€å‡ºåŠ›å½¢å¼ã€‘
ã€è²·ã„ç›®ææ¡ˆã€‘
ãƒ»ä¸‰é€£å˜ï¼šâ—-â—‹-â–²,â–³ ãªã©
ãƒ»ä¸‰é€£è¤‡ï¼šâ—â—‹â–² BOX ãªã©

ã€ãƒ¬ãƒ¼ã‚¹å±•é–‹äºˆæƒ³ã€‘
åºç›¤ã€œçµ‚ç›¤ã®æµã‚Œã‚’100æ–‡å­—ç¨‹åº¦ã§

ã€ç·è©•ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€‘
æ³¨æ„ç‚¹ã‚„ãƒã‚¤ãƒ³ãƒˆã‚’150æ–‡å­—ç¨‹åº¦ã§

${isLearningMode ? '' : 'â€»ã“ã®äºˆæƒ³ã¯AIã«ã‚ˆã‚‹åˆ†æã§ã™ã€‚'}` 
            }
          ],
        })
      });

      const phase4Data = await phase4Response.json();
      const phase4Text = phase4Data.content.map(item => item.text || "").join("\n");
      fullPrediction += phase4Text;

      if (isLearningMode) {
        setLearningPrediction(fullPrediction);
      } else {
        setPrediction(fullPrediction);
      }
      setAnalysisProgress('âœ“ åˆ†æå®Œäº†');
    } catch (error) {
      console.error('äºˆæƒ³ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
      const errorMsg = 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚äºˆæƒ³ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
      if (isLearningMode) {
        setLearningPrediction(errorMsg);
      } else {
        setPrediction(errorMsg);
      }
    } finally {
      setIsLoading(false);
    }
  };

  const analyzeAndLearn = async () => {
    if (!learningPrediction || !actualResult.trim()) {
      alert('äºˆæƒ³çµæœã¨å®Ÿéš›ã®ãƒ¬ãƒ¼ã‚¹çµæœã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    setIsLoading(true);
    setAnalysisProgress('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­...');

    try {
      // äºˆæƒ³ã¨çµæœã®çªåˆåˆ†æ
      const analysisResponse = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 2000,
          messages: [
            { 
              role: "user", 
              content: `ã‚ãªãŸã¯ç«¶é¦¬äºˆæƒ³ã®åˆ†æå°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®AIäºˆæƒ³ã¨å®Ÿéš›ã®ãƒ¬ãƒ¼ã‚¹çµæœã‚’æ¯”è¼ƒã—ã€å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

ã€AIäºˆæƒ³ã€‘
${learningPrediction}

ã€å®Ÿéš›ã®ãƒ¬ãƒ¼ã‚¹çµæœã€‘
${actualResult}

ã€ã‚¿ã‚¹ã‚¯ã€‘
ä»¥ä¸‹ã®é …ç›®ã«ã¤ã„ã¦åˆ†æã—ã¦ãã ã•ã„ï¼š

1. çš„ä¸­/ä¸çš„ä¸­ã®åˆ¤å®š
   - æœ¬å‘½â—ã®çµæœ
   - å¯¾æŠ—â—‹ã®çµæœ
   - å˜ç©´â–²ã®çµæœ
   - é€£ä¸‹â–³ã®çµæœ

2. äºˆæƒ³ãŒå¤–ã‚ŒãŸç†ç”±ï¼ˆå¤–ã‚ŒãŸå ´åˆï¼‰
   - ãƒ¬ãƒ¼ã‚¹å±•é–‹ã®èª­ã¿é•ã„
   - é¦¬ã®èƒ½åŠ›è©•ä¾¡ã®ãƒŸã‚¹
   - è¦‹è½ã¨ã—ãŸè¦å› 
   - ã‚ªãƒƒã‚ºã¨å®ŸåŠ›ã®ä¹–é›¢

3. äºˆæƒ³ãŒå½“ãŸã£ãŸç†ç”±ï¼ˆå½“ãŸã£ãŸå ´åˆï¼‰
   - æ­£ã—ãè©•ä¾¡ã§ããŸç‚¹
   - çš„ç¢ºã ã£ãŸåˆ†æ

4. ä»Šå¾Œã®æ”¹å–„ç‚¹
   - æ³¨ç›®ã™ã¹ãæ–°ã—ã„è¦ç´ 
   - é‡è¦–ã™ã¹ããƒ‡ãƒ¼ã‚¿
   - é¿ã‘ã‚‹ã¹ãåˆ¤æ–­ãƒ‘ã‚¿ãƒ¼ãƒ³

ã€å‡ºåŠ›å½¢å¼ã€‘
ã€çš„ä¸­åˆ¤å®šã€‘
æœ¬å‘½ï¼šâ—‹/Ã— ç€é †ï¼š
å¯¾æŠ—ï¼šâ—‹/Ã— ç€é †ï¼š
å˜ç©´ï¼šâ—‹/Ã— ç€é †ï¼š

ã€åˆ†æã€‘
ï¼ˆè©³ç´°ãªåˆ†æï¼‰

ã€å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆã€‘
1. 
2. 
3. 

ã€æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‘
ãƒ»
ãƒ»` 
            }
          ],
        })
      });

      const analysisData = await analysisResponse.json();
      const analysisText = analysisData.content.map(item => item.text || "").join("\n");
      setComparison(analysisText);

      // å­¦ç¿’å†…å®¹ã‚’ä¿å­˜
      setAnalysisProgress('å­¦ç¿’å†…å®¹ã‚’ä¿å­˜ä¸­...');
      
      const currentLearning = learningData || {
        totalLearnings: 0,
        insights: [],
        patterns: [],
        lastUpdated: null
      };

      // æ–°ã—ã„å­¦ç¿’å†…å®¹ã‚’è¿½åŠ 
      const newInsight = {
        date: new Date().toISOString(),
        raceName: extractedData.match(/ãƒ¬ãƒ¼ã‚¹å[ï¼š:]\s*(.+)/)?.[1] || 'ä¸æ˜',
        analysis: analysisText,
        prediction: learningPrediction.substring(0, 200),
        result: actualResult.substring(0, 200)
      };

      currentLearning.totalLearnings += 1;
      currentLearning.insights.unshift(newInsight);
      currentLearning.insights = currentLearning.insights.slice(0, 20); // æœ€æ–°20ä»¶ä¿æŒ
      currentLearning.lastUpdated = new Date().toISOString();

      const saveSuccess = await storageSet('learning:summary', JSON.stringify(currentLearning));
      
      if (!saveSuccess) {
        alert('âš ï¸ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
        setIsLoading(false);
        return;
      }
      
      // å€‹åˆ¥ã®å­¦ç¿’è¨˜éŒ²ã‚‚ä¿å­˜
      const learningId = `learning:${Date.now()}`;
      await storageSet(learningId, JSON.stringify(newInsight));

      setLearningData(currentLearning);
      setLearningCount(currentLearning.totalLearnings);
      setAnalysisProgress('âœ“ å­¦ç¿’å®Œäº†ï¼');

      console.log('ğŸ“š å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†:', {
        ç´¯è¨ˆå­¦ç¿’å›æ•°: currentLearning.totalLearnings,
        ä¿å­˜å…ˆ: saveSuccess ? 'localStorage' : 'window.storage',
        æœ€æ–°å­¦ç¿’: newInsight.raceName
      });

      alert(`âœ… å­¦ç¿’ãŒå®Œäº†ã—ã¾ã—ãŸï¼ï¼ˆç´¯è¨ˆ: ${currentLearning.totalLearnings}å›ï¼‰\næ¬¡å›ã®äºˆæƒ³ã‹ã‚‰å­¦ç¿’å†…å®¹ãŒæ´»ç”¨ã•ã‚Œã¾ã™ã€‚`);
    } catch (error) {
      console.error('å­¦ç¿’ã‚¨ãƒ©ãƒ¼:', error);
      alert('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    } finally {
      setIsLoading(false);
    }
  };

  const resetLearning = async () => {
    if (!confirm('ã™ã¹ã¦ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
      return;
    }

    try {
      await storageDelete('learning:summary');
      
      // å€‹åˆ¥ã®å­¦ç¿’è¨˜éŒ²ã‚‚å‰Šé™¤
      const keysList = await storageList('learning:');
      for (const key of keysList.keys) {
        await storageDelete(key);
      }

      setLearningData(null);
      setLearningCount(0);
      alert('âœ… å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚');
    } catch (error) {
      console.error('ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
      alert('âš ï¸ ãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    }
  };

  const copyToClipboard = async () => {
    try {
      const textToCopy = mode === 'learn' ? (comparison || learningPrediction) : prediction;
      await navigator.clipboard.writeText(textToCopy);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (error) {
      console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', error);
    }
  };

  const parsePrediction = (text) => {
    if (!text) return null;
    
    const sections = {};
    const lines = text.split('\n');
    let currentSection = '';
    let currentContent = [];

    lines.forEach(line => {
      if (line.startsWith('ã€') && line.includes('ã€‘')) {
        if (currentSection && currentContent.length > 0) {
          sections[currentSection] = currentContent.join('\n');
        }
        currentSection = line.replace(/ã€|ã€‘/g, '');
        currentContent = [];
      } else if (line.trim()) {
        currentContent.push(line);
      }
    });

    if (currentSection && currentContent.length > 0) {
      sections[currentSection] = currentContent.join('\n');
    }

    return sections;
  };

  const displayText = mode === 'learn' ? (comparison || learningPrediction) : prediction;
  const predictionSections = parsePrediction(displayText);

  return (
    <div className="min-h-screen bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50">
      {/* Header */}
      <div className="relative overflow-hidden">
        <div className="absolute inset-0 bg-gradient-to-r from-emerald-600/5 to-teal-600/5"></div>
        <div className="relative max-w-6xl mx-auto px-6 py-12">
          <div className="text-center">
            <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-emerald-500 to-teal-600 rounded-2xl mb-6 shadow-lg">
              <Trophy className="w-8 h-8 text-white" />
            </div>
            <h1 className="text-4xl font-bold bg-gradient-to-r from-slate-800 to-slate-600 bg-clip-text text-transparent mb-4">
              AIç«¶é¦¬äºˆæƒ³ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
            </h1>
            <p className="text-xl text-slate-600 max-w-2xl mx-auto">
              å­¦ç¿’æ©Ÿèƒ½ã§ç²¾åº¦ãŒé€²åŒ–ã™ã‚‹ç«¶é¦¬äºˆæƒ³AI
            </p>
            
            {/* å­¦ç¿’çŠ¶æ³è¡¨ç¤º */}
            {learningCount > 0 && (
              <div className="mt-4 inline-flex items-center gap-2 bg-purple-100 text-purple-700 px-4 py-2 rounded-full text-sm font-medium">
                <Brain className="w-4 h-4" />
                å­¦ç¿’å›æ•°: {learningCount}å›
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Mode Toggle */}
      <div className="max-w-6xl mx-auto px-6 mb-8">
        <div className="bg-white/70 backdrop-blur-sm rounded-2xl p-2 shadow-xl border border-white/20 inline-flex gap-2">
          <button
            onClick={() => setMode('predict')}
            className={`px-6 py-3 rounded-xl font-semibold transition-all flex items-center gap-2 ${
              mode === 'predict'
                ? 'bg-emerald-600 text-white shadow-lg'
                : 'text-slate-600 hover:bg-slate-100'
            }`}
          >
            <Target className="w-5 h-5" />
            é€šå¸¸äºˆæƒ³
          </button>
          <button
            onClick={() => setMode('learn')}
            className={`px-6 py-3 rounded-xl font-semibold transition-all flex items-center gap-2 ${
              mode === 'learn'
                ? 'bg-purple-600 text-white shadow-lg'
                : 'text-slate-600 hover:bg-slate-100'
            }`}
          >
            <BookOpen className="w-5 h-5" />
            å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰
          </button>
        </div>
      </div>

      {/* Main Content */}
      <div className="max-w-6xl mx-auto px-6 pb-12">
        {mode === 'predict' ? (
          // é€šå¸¸äºˆæƒ³ãƒ¢ãƒ¼ãƒ‰
          <div className="grid lg:grid-cols-2 gap-8">
            <div className="space-y-6">
              {/* PDF Upload */}
              <div className="bg-white/70 backdrop-blur-sm rounded-2xl p-8 shadow-xl border border-white/20">
                <div className="flex items-center gap-3 mb-6">
                  <div className="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                    <Upload className="w-5 h-5 text-blue-600" />
                  </div>
                  <h2 className="text-2xl font-semibold text-slate-800">STEP 1: å‡ºé¦¬è¡¨ï¼ˆPDF/ç”»åƒï¼‰</h2>
                </div>

                {!pdfFile ? (
                  <div>
                    <div className="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center">
                      <Upload className="w-12 h-12 text-slate-400 mx-auto mb-4" />
                      <p className="text-slate-700 font-medium mb-4">
                        JRAå‡ºé¦¬è¡¨PDFã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                      </p>
                      <label className="inline-block">
                        <input
                          type="file"
                          accept=".pdf,application/pdf"
                          onChange={handleFileUpload}
                          disabled={isAnalyzing}
                          className="hidden"
                        />
                        <span className="inline-block bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-6 rounded-lg cursor-pointer transition-colors active:bg-emerald-800">
                          ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                        </span>
                      </label>
                      <p className="text-xs text-slate-500 mt-3">
                        PDFã€JPGã€PNGç­‰ã®ç”»åƒå½¢å¼ã«å¯¾å¿œ
                      </p>
                    </div>
                  </div>
                ) : (
                  <div className="space-y-3">
                    <div className="bg-emerald-50 border border-emerald-200 rounded-xl p-4 flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <FileText className="w-8 h-8 text-emerald-600" />
                        <div>
                          <p className="font-medium text-slate-800">{pdfFile.name}</p>
                          <p className="text-sm text-slate-600">
                            {isAnalyzing ? 'è§£æä¸­...' : 'âœ“ è§£æå®Œäº†'}
                          </p>
                        </div>
                      </div>
                      {!isAnalyzing && (
                        <button
                          onClick={removePdf}
                          className="p-2 hover:bg-emerald-100 rounded-lg transition-colors"
                        >
                          <X className="w-5 h-5 text-slate-600" />
                        </button>
                      )}
                    </div>
                  </div>
                )}

                {isAnalyzing && (
                  <div className="mt-4 flex items-center gap-3 text-emerald-600">
                    <div className="w-5 h-5 border-2 border-emerald-600/30 border-t-emerald-600 rounded-full animate-spin"></div>
                    <span className="text-sm font-medium">PDFã‚’è§£æä¸­...</span>
                  </div>
                )}
              </div>

              {/* Web Search */}
              {extractedData && (
                <div className="bg-white/70 backdrop-blur-sm rounded-2xl p-8 shadow-xl border border-white/20">
                  <div className="flex items-center gap-3 mb-6">
                    <div className="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                      <Search className="w-5 h-5 text-purple-600" />
                    </div>
                    <h2 className="text-2xl font-semibold text-slate-800">STEP 2: è©³ç´°ãƒ‡ãƒ¼ã‚¿æ¤œç´¢</h2>
                  </div>

                  <button
                    onClick={searchWebData}
                    disabled={isSearching}
                    className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-4 px-8 rounded-xl font-semibold text-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3"
                  >
                    {isSearching ? (
                      <>
                        <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                        æ¤œç´¢ä¸­...
                      </>
                    ) : webData ? (
                      <>
                        <Check className="w-5 h-5" />
                        å†æ¤œç´¢ã™ã‚‹
                      </>
                    ) : (
                      <>
                        <Search className="w-5 h-5" />
                        è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
                      </>
                    )}
                  </button>

                  {searchProgress && (
                    <div className="mt-4 text-sm text-purple-600 font-medium">
                      {searchProgress}
                    </div>
                  )}
                </div>
              )}

              {/* Race Info */}
              {extractedData && (
                <div className="bg-white/70 backdrop-blur-sm rounded-2xl p-8 shadow-xl border border-white/20">
                  <div className="flex items-center justify-between mb-6">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center">
                        <TrendingUp className="w-5 h-5 text-emerald-600" />
                      </div>
                      <h2 className="text-2xl font-semibold text-slate-800">æŠ½å‡ºçµæœ</h2>
                    </div>
                    <button
                      onClick={() => setShowRawData(!showRawData)}
                      className="flex items-center gap-2 text-emerald-600 hover:text-emerald-700 font-medium transition-colors"
                    >
                      {showRawData ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
                      {showRawData ? 'é–‰ã˜ã‚‹' : 'ç·¨é›†'}
                    </button>
                  </div>

                  {showRawData ? (
                    <textarea
                      value={raceInfo}
                      onChange={(e) => setRaceInfo(e.target.value)}
                      className="w-full h-64 p-4 border border-slate-200 rounded-xl resize-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all duration-200 bg-white/50 text-slate-700 text-sm font-mono"
                    />
                  ) : (
                    <div className="bg-gradient-to-br from-slate-50 to-emerald-50/30 rounded-xl p-6 border border-slate-200 max-h-64 overflow-y-auto">
                      <pre className="whitespace-pre-wrap font-sans text-slate-700 leading-relaxed text-sm">
                        {extractedData}
                      </pre>
                    </div>
                  )}
                </div>
              )}

              {/* Prediction Style */}
              <div className="bg-white/70 backdrop-blur-sm rounded-2xl p-8 shadow-xl border border-white/20">
                <div className="flex items-center gap-3 mb-6">
                  <div className="w-10 h-10 bg-teal-100 rounded-xl flex items-center justify-center">
                    <Sparkles className="w-5 h-5 text-teal-600" />
                  </div>
                  <h2 className="text-2xl font-semibold text-slate-800">STEP 3: äºˆæƒ³ã‚¹ã‚¿ã‚¤ãƒ«</h2>
                </div>
                
                <div className="grid grid-cols-2 gap-3">
                  {styles.map((style) => (
                    <button
                      key={style.value}
                      onClick={() => setPredictionStyle(style.value)}
                      className={`p-4 rounded-xl border-2 transition-all duration-200 text-left ${
                        predictionStyle === style.value
                          ? 'border-emerald-500 bg-emerald-50 shadow-md'
                          : 'border-slate-200 bg-white/50 hover:border-slate-300 hover:bg-white/70'
                      }`}
                    >
                      <div className="font-medium text-slate-800">{style.label}</div>
                      <div className="text-sm text-slate-600 mt-1">{style.description}</div>
                    </button>
                  ))}
                </div>
              </div>

              {/* Additional Info */}
              <div className="bg-white/70 backdrop-blur-sm rounded-2xl p-8 shadow-xl border border-white/20">
                <div className="flex items-center justify-between mb-6">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center">
                      <Info className="w-5 h-5 text-slate-600" />
                    </div>
                    <h2 className="text-2xl font-semibold text-slate-800">è¿½åŠ æƒ…å ± (ä»»æ„)</h2>
                  </div>
                  <button
                    onClick={() => setShowPastData(!showPastData)}
                    className="text-emerald-600 hover:text-emerald-700 font-medium transition-colors"
                  >
                    {showPastData ? 'éè¡¨ç¤º' : 'è¡¨ç¤º'}
                  </button>
                </div>
                
                {showPastData && (
                  <>
                    <p className="text-slate-600 mb-4">
                      ãƒ‘ãƒ‰ãƒƒã‚¯æƒ…å ±ã€ã‚ªãƒƒã‚ºå¤‰å‹•ãªã©
                    </p>
                    <textarea
                      value={pastData}
                      onChange={(e) => setPastData(e.target.value)}
                      placeholder="è¿½åŠ ã§è€ƒæ…®ã—ã¦ã»ã—ã„æƒ…å ±ã‚’å…¥åŠ›..."
                      className="w-full h-32 p-4 border border-slate-200 rounded-xl resize-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all duration-200 bg-white/50 text-slate-700 placeholder-slate-400"
                    />
                  </>
                )}
              </div>

              {/* Generate Button */}
              <button
                onClick={() => generatePrediction(false)}
                disabled={isLoading || !raceInfo.trim()}
                className="w-full bg-gradient-to-r from-emerald-600 to-teal-600 text-white py-4 px-8 rounded-xl font-semibold text-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3"
              >
                {isLoading ? (
                  <>
                    <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                    {analysisProgress || 'äºˆæƒ³ã‚’åˆ†æä¸­...'}
                  </>
                ) : (
                  <>
                    <Trophy className="w-5 h-5" />
                    {learningCount > 0 ? `AIäºˆæƒ³ã‚’ç”Ÿæˆï¼ˆå­¦ç¿’æ¸ˆã¿Ã—${learningCount}ï¼‰` : 'AIäºˆæƒ³ã‚’ç”Ÿæˆï¼ˆ4æ®µéšåˆ†æï¼‰'}
                  </>
                )}
              </button>
            </div>

            {/* Output Column */}
            <div className="space-y-6">
              <div className="bg-white/70 backdrop-blur-sm rounded-2xl p-8 shadow-xl border border-white/20">
                <div className="flex items-center justify-between mb-6">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
                      <Trophy className="w-5 h-5 text-amber-600" />
                    </div>
                    <h2 className="text-2xl font-semibold text-slate-800">AIäºˆæƒ³çµæœ</h2>
                  </div>
                  
                  {prediction && (
                    <button
                      onClick={copyToClipboard}
                      className="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors text-slate-700 font-medium"
                    >
                      {copied ? (
                        <>
                          <Check className="w-4 h-4 text-green-600" />
                          ã‚³ãƒ”ãƒ¼å®Œäº†
                        </>
                      ) : (
                        <>
                          <Copy className="w-4 h-4" />
                          ã‚³ãƒ”ãƒ¼
                        </>
                      )}
                    </button>
                  )}
                </div>
                
                {predictionSections ? (
                  <div className="space-y-4 max-h-[700px] overflow-y-auto">
                    {predictionSections['ãƒ¬ãƒ¼ã‚¹åˆ†æ'] && (
                      <div className="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl p-5 border border-blue-100">
                        <h3 className="font-bold text-blue-900 mb-3 flex items-center gap-2">
                          <TrendingUp className="w-5 h-5" />
                          ãƒ¬ãƒ¼ã‚¹åˆ†æ
                        </h3>
                        <p className="text-slate-700 leading-relaxed whitespace-pre-wrap">{predictionSections['ãƒ¬ãƒ¼ã‚¹åˆ†æ']}</p>
                      </div>
                    )}

                    {predictionSections['å„é¦¬è©•ä¾¡'] && (
                      <div className="bg-gradient-to-br from-slate-50 to-gray-50 rounded-xl p-5 border border-slate-200">
                        <h3 className="font-bold text-slate-800 mb-3">ğŸ“Š å„é¦¬è©•ä¾¡</h3>
                        <p className="text-slate-700 leading-relaxed whitespace-pre-wrap text-sm">{predictionSections['å„é¦¬è©•ä¾¡']}</p>
                      </div>
                    )}

                    <div className="grid grid-cols-1 gap-3">
                      {predictionSections['æœ¬å‘½'] && (
                        <div className="bg-gradient-to-br from-red-50 to-pink-50 rounded-xl p-5 border-2 border-red-200">
                          <h3 className="font-bold text-red-700 mb-2 text-lg flex items-center gap-2">
                            <span className="text-2xl">â—</span> æœ¬å‘½
                          </h3>
                          <p className="text-slate-700 leading-relaxed whitespace-pre-wrap text-sm">{predictionSections['æœ¬å‘½']}</p>
                        </div>
                      )}

                      {predictionSections['å¯¾æŠ—'] && (
                        <div className="bg-gradient-to-br from-orange-50 to-amber-50 rounded-xl p-5 border-2 border-orange-200">
                          <h3 className="font-bold text-orange-700 mb-2 text-lg flex items-center gap-2">
                            <span className="text-2xl">â—‹</span> å¯¾æŠ—
                          </h3>
                          <p className="text-slate-700 leading-relaxed whitespace-pre-wrap text-sm">{predictionSections['å¯¾æŠ—']}</p>
                        </div>
                      )}

                      {predictionSections['å˜ç©´'] && (
                        <div className="bg-gradient-to-br from-yellow-50 to-lime-50 rounded-xl p-5 border-2 border-yellow-200">
                          <h3 className="font-bold text-yellow-700 mb-2 text-lg flex items-center gap-2">
                            <span className="text-2xl">â–²</span> å˜ç©´
                          </h3>
                          <p className="text-slate-700 leading-relaxed whitespace-pre-wrap text-sm">{predictionSections['å˜ç©´']}</p>
                        </div>
                      )}

                      {predictionSections['é€£ä¸‹'] && (
                        <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-5 border-2 border-green-200">
                          <h3 className="font-bold text-green-700 mb-2 text-lg flex items-center gap-2">
                            <span className="text-2xl">â–³</span> é€£ä¸‹
                          </h3>
                          <p className="text-slate-700 leading-relaxed whitespace-pre-wrap text-sm">{predictionSections['é€£ä¸‹']}</p>
                        </div>
                      )}
                    </div>

                    {predictionSections['è²·ã„ç›®ææ¡ˆ'] && (
                      <div className="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl p-5 border border-purple-200">
                        <h3 className="font-bold text-purple-900 mb-3 flex items-center gap-2">
                          ğŸ¯ è²·ã„ç›®ææ¡ˆ
                        </h3>
                        <div className="text-slate-700 leading-relaxed whitespace-pre-wrap">{predictionSections['è²·ã„ç›®ææ¡ˆ']}</div>
                      </div>
                    )}

                    {predictionSections['ãƒ¬ãƒ¼ã‚¹å±•é–‹äºˆæƒ³'] && (
                      <div className="bg-gradient-to-br from-slate-50 to-gray-50 rounded-xl p-5 border border-slate-200">
                        <h3 className="font-bold text-slate-800 mb-3">ğŸ“Š ãƒ¬ãƒ¼ã‚¹å±•é–‹äºˆæƒ³</h3>
                        <p className="text-slate-700 leading-relaxed whitespace-pre-wrap">{predictionSections['ãƒ¬ãƒ¼ã‚¹å±•é–‹äºˆæƒ³']}</p>
                      </div>
                    )}

                    {predictionSections['ç·è©•ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹'] && (
                      <div className="bg-gradient-to-br from-teal-50 to-cyan-50 rounded-xl p-5 border border-teal-200">
                        <h3 className="font-bold text-teal-900 mb-3">ğŸ’­ ç·è©•ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h3>
                        <p className="text-slate-700 leading-relaxed whitespace-pre-wrap">{predictionSections['ç·è©•ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹']}</p>
                      </div>
                    )}
                  </div>
                ) : (
                  <div className="flex flex-col items-center justify-center h-64 text-slate-400">
                    <Trophy className="w-16 h-16 mb-4 opacity-50" />
                    <p className="text-lg">äºˆæƒ³çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    <p className="text-sm mt-2 text-center px-4">
                      {learningCount > 0 ? 'å­¦ç¿’æ¸ˆã¿AIãŒäºˆæƒ³ã‚’ç”Ÿæˆã—ã¾ã™' : 'PDF â†’ ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ â†’ äºˆæƒ³ç”Ÿæˆ'}
                    </p>
                  </div>
                )}
              </div>

              <div className="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-2xl p-6 border border-emerald-100">
                <h3 className="font-semibold text-slate-800 mb-3">ğŸ’¡ å­¦ç¿’æ©Ÿèƒ½ã«ã¤ã„ã¦</h3>
                <ul className="text-sm text-slate-600 space-y-2">
                  <li>â€¢ å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã§éå»ãƒ¬ãƒ¼ã‚¹ã‚’åˆ†æ</li>
                  <li>â€¢ <strong>PDFãƒ»ç”»åƒã©ã¡ã‚‰ã§ã‚‚OK</strong> ğŸ“„ğŸ“¸</li>
                  <li>â€¢ <strong>ãƒ¬ãƒ¼ã‚¹çµæœã¯è‡ªå‹•æ¤œç´¢ã§å–å¾—</strong> ğŸ”</li>
                  <li>â€¢ äºˆæƒ³ã¨çµæœã‚’æ¯”è¼ƒã—ã¦æ”¹å–„ç‚¹ã‚’æŠ½å‡º</li>
                  <li>â€¢ å­¦ç¿’å†…å®¹ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œæ¬¡å›ã«æ´»ç”¨</li>
                  <li>â€¢ å­¦ç¿’å›æ•°ãŒå¢—ãˆã‚‹ã»ã©ç²¾åº¦å‘ä¸Š</li>
                </ul>
              </div>

              {/* Disclaimer */}
              <div className="bg-red-50 rounded-2xl p-6 border border-red-100">
                <h3 className="font-semibold text-red-800 mb-2">âš ï¸ æ³¨æ„äº‹é …</h3>
                <p className="text-sm text-red-700">
                  ã“ã®äºˆæƒ³ã¯AIã«ã‚ˆã‚‹åˆ†æã§ã™ã€‚é¦¬åˆ¸è³¼å…¥ã¯è‡ªå·±è²¬ä»»ã§ã€‚
                </p>
              </div>
            </div>
          </div>
        ) : (
          // å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰
          <div className="grid lg:grid-cols-2 gap-8">
            <div className="space-y-6">
              {/* PDF Upload for Learning */}
              <div className="bg-white/70 backdrop-blur-sm rounded-2xl p-8 shadow-xl border-2 border-purple-200">
                <div className="flex items-center gap-3 mb-6">
                  <div className="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                    <BookOpen className="w-5 h-5 text-purple-600" />
                  </div>
                  <h2 className="text-2xl font-semibold text-slate-800">STEP 1: éå»ãƒ¬ãƒ¼ã‚¹ï¼ˆPDF/ç”»åƒï¼‰</h2>
                </div>

                <div className="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
                  <p className="text-sm text-purple-700">
                    <AlertCircle className="w-4 h-4 inline mr-2" />
                    çµ‚äº†æ¸ˆã¿ã®ãƒ¬ãƒ¼ã‚¹PDFã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„
                  </p>
                </div>

                {!pdfFile ? (
                  <div>
                    <div className="border-2 border-dashed border-purple-300 rounded-xl p-8 text-center">
                      <Upload className="w-12 h-12 text-purple-400 mx-auto mb-4" />
                      <p className="text-slate-700 font-medium mb-4">
                        éå»ãƒ¬ãƒ¼ã‚¹ã®å‡ºé¦¬è¡¨ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                      </p>
                      <label className="inline-block">
                        <input
                          type="file"
                          accept=".pdf,application/pdf"
                          onChange={handleFileUpload}
                          disabled={isAnalyzing}
                          className="hidden"
                        />
                        <span className="inline-block bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg cursor-pointer transition-colors active:bg-purple-800">
                          ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆPDF/ç”»åƒï¼‰
                        </span>
                      </label>
                    </div>
                  </div>
                ) : (
                  <div className="space-y-3">
                    <div className="bg-purple-50 border border-purple-200 rounded-xl p-4 flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <FileText className="w-8 h-8 text-purple-600" />
                        <div>
                          <p className="font-medium text-slate-800">{pdfFile.name}</p>
                          <p className="text-sm text-slate-600">
                            {isAnalyzing ? 'è§£æä¸­...' : 'âœ“ è§£æå®Œäº†'}
                          </p>
                        </div>
                      </div>
                      {!isAnalyzing && (
                        <button
                          onClick={removePdf}
                          className="p-2 hover:bg-purple-100 rounded-lg transition-colors"
                        >
                          <X className="w-5 h-5 text-slate-600" />
                        </button>
                      )}
                    </div>
                  </div>
                )}

                {isAnalyzing && (
                  <div className="mt-4 flex items-center gap-3 text-purple-600">
                    <div className="w-5 h-5 border-2 border-purple-600/30 border-t-purple-600 rounded-full animate-spin"></div>
                    <span className="text-sm font-medium">PDFã‚’è§£æä¸­...</span>
                  </div>
                )}
              </div>

              {/* Generate Prediction for Learning */}
              {extractedData && !learningPrediction && (
                <div className="bg-white/70 backdrop-blur-sm rounded-2xl p-8 shadow-xl border border-white/20">
                  <div className="flex items-center gap-3 mb-6">
                    <div className="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center">
                      <Brain className="w-5 h-5 text-indigo-600" />
                    </div>
                    <h2 className="text-2xl font-semibold text-slate-800">STEP 2: AIäºˆæƒ³ç”Ÿæˆ</h2>
                  </div>

                  <p className="text-slate-600 mb-4">
                    çµæœã‚’ä¼ã›ãŸçŠ¶æ…‹ã§AIã«äºˆæƒ³ã•ã›ã¾ã™
                  </p>

                  <button
                    onClick={() => generatePrediction(true)}
                    disabled={isLoading}
                    className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 px-8 rounded-xl font-semibold text-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3"
                  >
                    {isLoading ? (
                      <>
                        <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                        {analysisProgress || 'äºˆæƒ³ç”Ÿæˆä¸­...'}
                      </>
                    ) : (
                      <>
                        <Brain className="w-5 h-5" />
                        AIäºˆæƒ³ã‚’ç”Ÿæˆ
                      </>
                    )}
                  </button>
                </div>
              )}

              {/* Actual Result Search/Input */}
              {learningPrediction && !comparison && (
                <div className="bg-white/70 backdrop-blur-sm rounded-2xl p-8 shadow-xl border border-white/20">
                  <div className="flex items-center gap-3 mb-6">
                    <div className="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
                      <Trophy className="w-5 h-5 text-amber-600" />
                    </div>
                    <h2 className="text-2xl font-semibold text-slate-800">STEP 3: å®Ÿéš›ã®çµæœ</h2>
                  </div>

                  <p className="text-slate-600 mb-4">
                    ãƒ¬ãƒ¼ã‚¹çµæœã‚’è‡ªå‹•æ¤œç´¢ã€ã¾ãŸã¯æ‰‹å‹•å…¥åŠ›
                  </p>

                  {/* Auto Search Button */}
                  <button
                    onClick={searchActualResult}
                    disabled={isSearching}
                    className="w-full mb-4 bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-4 px-8 rounded-xl font-semibold text-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3"
                  >
                    {isSearching ? (
                      <>
                        <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                        çµæœã‚’æ¤œç´¢ä¸­...
                      </>
                    ) : (
                      <>
                        <Search className="w-5 h-5" />
                        ãƒ¬ãƒ¼ã‚¹çµæœã‚’è‡ªå‹•æ¤œç´¢
                      </>
                    )}
                  </button>

                  {searchProgress && (
                    <div className="mb-4 text-sm text-blue-600 font-medium">
                      {searchProgress}
                    </div>
                  )}

                  {/* Manual Input */}
                  <div className="relative">
                    <div className="absolute top-0 left-0 right-0 text-center">
                      <span className="bg-white px-3 py-1 text-xs text-slate-500 rounded-full border border-slate-200">
                        ã¾ãŸã¯æ‰‹å‹•å…¥åŠ›
                      </span>
                    </div>
                    <textarea
                      value={actualResult}
                      onChange={(e) => setActualResult(e.target.value)}
                      placeholder="ä¾‹ï¼š&#10;1ç€: 5ç•ª â—‹â—‹ãƒ›ãƒ¼ã‚¹&#10;2ç€: 3ç•ª â–³â–³ã‚¹ã‚¿ãƒ¼&#10;3ç€: 1ç•ª â–¡â–¡ã‚¸ãƒ£ãƒ³ãƒ—&#10;&#10;å˜å‹: 5ç•ª 850å††&#10;é¦¬é€£: 3-5 2,340å††"
                      className="w-full h-48 p-4 pt-10 border border-slate-200 rounded-xl resize-none focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all duration-200 bg-white/50 text-slate-700 placeholder-slate-400"
                    />
                  </div>

                  <button
                    onClick={analyzeAndLearn}
                    disabled={isLoading || !actualResult.trim()}
                    className="w-full mt-4 bg-gradient-to-r from-amber-600 to-orange-600 text-white py-4 px-8 rounded-xl font-semibold text-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3"
                  >
                    {isLoading ? (
                      <>
                        <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                        {analysisProgress || 'åˆ†æä¸­...'}
                      </>
                    ) : (
                      <>
                        <Brain className="w-5 h-5" />
                        åˆ†æã—ã¦å­¦ç¿’ã™ã‚‹
                      </>
                    )}
                  </button>
                </div>
              )}

              {/* Learning Data Display */}
              {learningData && (
                <div className="bg-white/70 backdrop-blur-sm rounded-2xl p-8 shadow-xl border border-white/20">
                  <div className="flex items-center justify-between mb-6">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
                        <Brain className="w-5 h-5 text-green-600" />
                      </div>
                      <h2 className="text-2xl font-semibold text-slate-800">å­¦ç¿’ãƒ‡ãƒ¼ã‚¿</h2>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={async () => {
                          const value = await storageGet('learning:summary');
                          if (value) {
                            console.log('ä¿å­˜æ¸ˆã¿å­¦ç¿’ãƒ‡ãƒ¼ã‚¿:', JSON.parse(value));
                            alert('âœ… ãƒ‡ãƒ¼ã‚¿ã¯æ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚\nè©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆF12ã‚­ãƒ¼ï¼‰');
                          } else {
                            alert('âš ï¸ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                          }
                        }}
                        className="text-blue-600 hover:text-blue-700 text-sm font-medium"
                      >
                        ä¿å­˜ç¢ºèª
                      </button>
                      <button
                        onClick={resetLearning}
                        className="text-red-600 hover:text-red-700 text-sm font-medium"
                      >
                        ãƒªã‚»ãƒƒãƒˆ
                      </button>
                    </div>
                  </div>

                  <div className="space-y-3">
                    <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                      <p className="text-sm font-medium text-green-800 mb-2">å­¦ç¿’çŠ¶æ³</p>
                      <p className="text-2xl font-bold text-green-900">{learningData.totalLearnings}å›</p>
                      <p className="text-xs text-green-700 mt-1">
                        æœ€çµ‚æ›´æ–°: {learningData.lastUpdated ? new Date(learningData.lastUpdated).toLocaleDateString('ja-JP') : '-'}
                      </p>
                    </div>

                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 max-h-64 overflow-y-auto">
                      <p className="text-sm font-medium text-blue-800 mb-3">æœ€è¿‘ã®å­¦ç¿’å±¥æ­´</p>
                      {learningData.insights.slice(0, 5).map((insight, idx) => (
                        <div key={idx} className="mb-3 pb-3 border-b border-blue-200 last:border-0">
                          <p className="text-xs text-blue-600 mb-1">
                            {new Date(insight.date).toLocaleDateString('ja-JP')}
                          </p>
                          <p className="text-sm text-slate-700 font-medium">{insight.raceName}</p>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Output Column for Learning */}
            <div className="space-y-6">
              <div className="bg-white/70 backdrop-blur-sm rounded-2xl p-8 shadow-xl border border-white/20">
                <div className="flex items-center justify-between mb-6">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                      {comparison ? <Brain className="w-5 h-5 text-purple-600" /> : <Trophy className="w-5 h-5 text-purple-600" />}
                    </div>
                    <h2 className="text-2xl font-semibold text-slate-800">
                      {comparison ? 'å­¦ç¿’çµæœ' : learningPrediction ? 'AIäºˆæƒ³' : 'çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢'}
                    </h2>
                  </div>
                  
                  {(learningPrediction || comparison) && (
                    <button
                      onClick={copyToClipboard}
                      className="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors text-slate-700 font-medium"
                    >
                      {copied ? (
                        <>
                          <Check className="w-4 h-4 text-green-600" />
                          ã‚³ãƒ”ãƒ¼å®Œäº†
                        </>
                      ) : (
                        <>
                          <Copy className="w-4 h-4" />
                          ã‚³ãƒ”ãƒ¼
                        </>
                      )}
                    </button>
                  )}
                </div>
                
                {predictionSections ? (
                  <div className="space-y-4 max-h-[700px] overflow-y-auto">
                    {comparison ? (
                      // å­¦ç¿’åˆ†æçµæœ
                      <>
                        {predictionSections['çš„ä¸­åˆ¤å®š'] && (
                          <div className="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-5 border-2 border-amber-200">
                            <h3 className="font-bold text-amber-900 mb-3">ğŸ¯ çš„ä¸­åˆ¤å®š</h3>
                            <pre className="text-slate-700 leading-relaxed whitespace-pre-wrap font-sans">{predictionSections['çš„ä¸­åˆ¤å®š']}</pre>
                          </div>
                        )}

                        {predictionSections['åˆ†æ'] && (
                          <div className="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl p-5 border border-blue-200">
                            <h3 className="font-bold text-blue-900 mb-3">ğŸ“Š è©³ç´°åˆ†æ</h3>
                            <p className="text-slate-700 leading-relaxed whitespace-pre-wrap">{predictionSections['åˆ†æ']}</p>
                          </div>
                        )}

                        {predictionSections['å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ'] && (
                          <div className="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl p-5 border-2 border-purple-200">
                            <h3 className="font-bold text-purple-900 mb-3 flex items-center gap-2">
                              <Brain className="w-5 h-5" />
                              å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ
                            </h3>
                            <p className="text-slate-700 leading-relaxed whitespace-pre-wrap">{predictionSections['å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ']}</p>
                          </div>
                        )}

                        {predictionSections['æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³'] && (
                          <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-5 border border-green-200">
                            <h3 className="font-bold text-green-900 mb-3">âœ¨ æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
                            <p className="text-slate-700 leading-relaxed whitespace-pre-wrap">{predictionSections['æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³']}</p>
                          </div>
                        )}
                      </>
                    ) : (
                      // é€šå¸¸ã®äºˆæƒ³è¡¨ç¤º
                      <>
                        {predictionSections['ãƒ¬ãƒ¼ã‚¹åˆ†æ'] && (
                          <div className="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl p-5 border border-blue-100">
                            <h3 className="font-bold text-blue-900 mb-3">ãƒ¬ãƒ¼ã‚¹åˆ†æ</h3>
                            <p className="text-slate-700 leading-relaxed whitespace-pre-wrap">{predictionSections['ãƒ¬ãƒ¼ã‚¹åˆ†æ']}</p>
                          </div>
                        )}

                        <div className="grid grid-cols-1 gap-3">
                          {predictionSections['æœ¬å‘½'] && (
                            <div className="bg-gradient-to-br from-red-50 to-pink-50 rounded-xl p-5 border-2 border-red-200">
                              <h3 className="font-bold text-red-700 mb-2 text-lg">â— æœ¬å‘½</h3>
                              <p className="text-slate-700 leading-relaxed whitespace-pre-wrap text-sm">{predictionSections['æœ¬å‘½']}</p>
                            </div>
                          )}

                          {predictionSections['å¯¾æŠ—'] && (
                            <div className="bg-gradient-to-br from-orange-50 to-amber-50 rounded-xl p-5 border-2 border-orange-200">
                              <h3 className="font-bold text-orange-700 mb-2 text-lg">â—‹ å¯¾æŠ—</h3>
                              <p className="text-slate-700 leading-relaxed whitespace-pre-wrap text-sm">{predictionSections['å¯¾æŠ—']}</p>
                            </div>
                          )}

                          {predictionSections['å˜ç©´'] && (
                            <div className="bg-gradient-to-br from-yellow-50 to-lime-50 rounded-xl p-5 border-2 border-yellow-200">
                              <h3 className="font-bold text-yellow-700 mb-2 text-lg">â–² å˜ç©´</h3>
                              <p className="text-slate-700 leading-relaxed whitespace-pre-wrap text-sm">{predictionSections['å˜ç©´']}</p>
                            </div>
                          )}

                          {predictionSections['é€£ä¸‹'] && (
                            <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-5 border-2 border-green-200">
                              <h3 className="font-bold text-green-700 mb-2 text-lg">â–³ é€£ä¸‹</h3>
                              <p className="text-slate-700 leading-relaxed whitespace-pre-wrap text-sm">{predictionSections['é€£ä¸‹']}</p>
                            </div>
                          )}
                        </div>

                        {predictionSections['è²·ã„ç›®ææ¡ˆ'] && (
                          <div className="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl p-5 border border-purple-200">
                            <h3 className="font-bold text-purple-900 mb-3">ğŸ¯ è²·ã„ç›®ææ¡ˆ</h3>
                            <div className="text-slate-700 leading-relaxed whitespace-pre-wrap">{predictionSections['è²·ã„ç›®ææ¡ˆ']}</div>
                          </div>
                        )}
                      </>
                    )}
                  </div>
                ) : (
                  <div className="flex flex-col items-center justify-center h-64 text-slate-400">
                    <BookOpen className="w-16 h-16 mb-4 opacity-50" />
                    <p className="text-lg">å­¦ç¿’çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    <p className="text-sm mt-2 text-center px-4">
                      PDF â†’ AIäºˆæƒ³ â†’ çµæœã‚’è‡ªå‹•æ¤œç´¢ â†’ å­¦ç¿’
                    </p>
                  </div>
                )}
              </div>

              <div className="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-2xl p-6 border border-purple-200">
                <h3 className="font-semibold text-slate-800 mb-3">ğŸ“š å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã®ä½¿ã„æ–¹</h3>
                <ul className="text-sm text-slate-600 space-y-2">
                  <li>â€¢ éå»ã®çµ‚äº†æ¸ˆã¿ãƒ¬ãƒ¼ã‚¹ï¼ˆPDF/ç”»åƒï¼‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</li>
                  <li>â€¢ çµæœã‚’ä¼ã›ãŸçŠ¶æ…‹ã§AIã«äºˆæƒ³ã•ã›ã‚‹</li>
                  <li>â€¢ <strong>ã€Œãƒ¬ãƒ¼ã‚¹çµæœã‚’è‡ªå‹•æ¤œç´¢ã€ã§çµæœã‚’å–å¾—</strong> â­ï¸</li>
                  <li>â€¢ ã¾ãŸã¯æ‰‹å‹•å…¥åŠ›ã‚‚å¯èƒ½</li>
                  <li>â€¢ AIãŒäºˆæƒ³ã®ã‚ºãƒ¬ã‚’åˆ†æã—ã¦å­¦ç¿’</li>
                  <li>â€¢ å­¦ç¿’å†…å®¹ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œæ¬¡å›ã«æ´»ç”¨</li>
                </ul>
              </div>

              {/* Comparison Button */}
              {comparison && (
                <button
                  onClick={() => {
                    setLearningPrediction('');
                    setActualResult('');
                    setComparison('');
                    removePdf();
                  }}
                  className="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-4 px-8 rounded-xl font-semibold text-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center gap-3"
                >
                  <BookOpen className="w-5 h-5" />
                  æ–°ã—ã„ãƒ¬ãƒ¼ã‚¹ã§å­¦ç¿’ã™ã‚‹
                </button>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
